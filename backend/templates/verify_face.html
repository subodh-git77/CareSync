{% extends "base.html" %}
{% block content %}

<!-- üé• Face Verification Page -->
<section class="min-h-screen flex items-center justify-center bg-animated-gradient py-12 px-4">
  <div class="w-full max-w-2xl bg-white/90 backdrop-blur-md shadow-2xl rounded-2xl border border-blue-100 p-6 sm:p-8 text-center">

    <!-- üß† Header -->
    <div class="flex flex-col items-center mb-6">
      <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-md">
        <i data-lucide="camera" class="w-8 h-8 sm:w-10 sm:h-10 text-white"></i>
      </div>
      <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mt-4">
        Face Verification for <span class="text-blue-600">{{ name }}</span>
      </h2>
      <p class="text-gray-600 text-sm mt-2">
        Keep your face centered and still for a few seconds while we verify your identity.
      </p>
    </div>

    <!-- üì∏ Camera Box -->
    <div id="cameraBox" class="relative w-full max-w-md mx-auto rounded-xl overflow-hidden border-4 border-blue-500 shadow-lg transition-all duration-300">
      <video id="video" autoplay playsinline class="w-full h-auto rounded-xl bg-black"></video>
      <canvas id="canvas" style="display:none;"></canvas>

      <!-- üîÑ Spinner -->
      <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center bg-black/40 hidden">
        <div class="w-12 h-12 sm:w-14 sm:h-14 border-4 border-white/50 border-t-blue-500 rounded-full animate-spin"></div>
      </div>
    </div>

    <!-- üìä Progress -->
    <div class="w-full bg-gray-200 rounded-full h-3 mt-5 overflow-hidden">
      <div id="progress-bar" class="h-3 w-0 bg-gradient-to-r from-blue-500 to-green-500 transition-all duration-300 ease-in-out"></div>
    </div>

    <!-- üìã Status -->
    <p id="status-text" class="mt-4 text-gray-700 font-medium">Ready when you are.</p>

    <!-- ‚ñ∂ Start Button -->
    <button id="startBtn"
      class="mt-5 px-5 sm:px-6 py-3 bg-gradient-to-r from-blue-600 to-green-500 text-white font-semibold rounded-xl shadow-md hover:shadow-lg hover:scale-[1.03] transition-all flex items-center justify-center gap-2 mx-auto">
      <i data-lucide="play-circle" class="w-5 h-5"></i> Start Verification
    </button>

    <!-- üí° Tips -->
    <div class="mt-6 text-sm bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg inline-flex items-center gap-2 text-left mx-auto">
      <i data-lucide="info" class="w-4 h-4"></i>
      <span>Ensure good lighting and keep your face visible to the camera for best results.</span>
    </div>
  </div>
</section>

<!-- üåà Styles -->
<style>
.bg-animated-gradient {
  background: linear-gradient(135deg, #e3f2fd, #e8f5e9);
  background-size: 400% 400%;
  animation: gradientShift 8s ease infinite;
}
@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* üîµ Pulse Animation Variants */
.pulse-blue { animation: pulseBlue 1.5s ease-in-out infinite; }
.pulse-green { animation: pulseGreen 1.5s ease-in-out infinite; }
.pulse-red { animation: pulseRed 1.5s ease-in-out infinite; }

@keyframes pulseBlue {
  0%,100% { box-shadow:0 0 15px rgba(37,99,235,0.5), 0 0 25px rgba(37,99,235,0.3); border-color:#3b82f6; }
  50% { box-shadow:0 0 30px rgba(37,99,235,0.8), 0 0 45px rgba(37,99,235,0.5); border-color:#2563eb; }
}
@keyframes pulseGreen {
  0%,100% { box-shadow:0 0 15px rgba(16,185,129,0.5), 0 0 25px rgba(16,185,129,0.3); border-color:#10b981; }
  50% { box-shadow:0 0 30px rgba(16,185,129,0.8), 0 0 45px rgba(16,185,129,0.5); border-color:#059669; }
}
@keyframes pulseRed {
  0%,100% { box-shadow:0 0 15px rgba(239,68,68,0.5), 0 0 25px rgba(239,68,68,0.3); border-color:#ef4444; }
  50% { box-shadow:0 0 30px rgba(239,68,68,0.8), 0 0 45px rgba(239,68,68,0.5); border-color:#dc2626; }
}

/* üì± Responsive Camera */
@media (max-width: 640px) {
  .capture-card { padding: 20px; }
  #cameraBox { width: 100%; border-width: 3px; }
  video { height: auto; }
}
</style>

<!-- üéØ Script -->
<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const statusText = document.getElementById('status-text');
const startBtn = document.getElementById('startBtn');
const progressBar = document.getElementById('progress-bar');
const spinner = document.getElementById('loading-spinner');
const cameraBox = document.getElementById('cameraBox');
const userId = "{{ user_id }}";

let streamStarted = false;
let verified = false;
let attempts = 0;
let frameSkip = 0;

// === Start Webcam ===
navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
  .then(stream => {
    video.srcObject = stream;
    streamStarted = true;
  })
  .catch(err => {
    alert("‚ö†Ô∏è Please allow camera access.\nError: " + err);
    statusText.textContent = "Camera access required.";
    startBtn.disabled = true;
  });

// === Send Frame ===
async function sendFrame() {
  if (!streamStarted || verified) return;
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imgData = canvas.toDataURL('image/jpeg', 0.7);

  try {
    const res = await fetch("{{ url_for('patient.verify_frame') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ image: imgData, user_id: userId })
    });
    const result = await res.json();
    if (result.status === "verified") {
      verified = true;
      onVerifiedSuccess();
    }
  } catch (e) {
    console.warn("Network delay:", e);
  }

  attempts++;
  progressBar.style.width = `${Math.min((attempts / 20) * 100, 100)}%`;
}

// === Continuous Capture ===
function continuousVerify() {
  if (verified || attempts >= 20) {
    onVerifyEnd();
    return;
  }
  if (frameSkip % 2 === 0) sendFrame();
  frameSkip++;
  requestAnimationFrame(continuousVerify);
}

// === Start Button ===
startBtn.onclick = () => {
  startBtn.disabled = true;
  spinner.classList.remove("hidden");
  cameraBox.classList.remove("pulse-green", "pulse-red");
  cameraBox.classList.add("pulse-blue");
  statusText.textContent = "üîé Verifying...";
  statusText.style.color = "#1d4ed8";
  verified = false;
  attempts = 0;
  frameSkip = 0;
  progressBar.style.width = "0%";
  continuousVerify();
};

// === Success ===
function onVerifiedSuccess() {
  spinner.classList.add("hidden");
  cameraBox.classList.remove("pulse-blue");
  cameraBox.classList.add("pulse-green");
  statusText.textContent = "‚úÖ Verification Successful!";
  statusText.style.color = "#16a34a";
  progressBar.style.width = "100%";
  setTimeout(() => window.location.href = "{{ url_for('patient.details') }}", 1200);
}

// === Fail / Timeout ===
function onVerifyEnd() {
  if (!verified) {
    spinner.classList.add("hidden");
    cameraBox.classList.remove("pulse-blue");
    cameraBox.classList.add("pulse-red");
    statusText.textContent = "‚ùå Verification Failed. Try again.";
    statusText.style.color = "#dc2626";
    startBtn.disabled = false;
    progressBar.style.width = "0%";
  }
}
</script>

<!-- ‚úÖ Lucide Icons -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    if (typeof lucide !== 'undefined') lucide.createIcons();
  });
</script>

{% endblock %}
